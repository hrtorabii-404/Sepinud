<!doctype html>
<html lang="fa" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>داشبورد امکان‌سنجی فنی-اقتصادی | انبار 2240 متری</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <style>
    :root {
      /* Light Theme Variables */
      --primary: #4f46e5;
      --secondary: #0ea5e9;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #0f172a;
      --muted: #64748b;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --border: #e2e8f0;
      --chart-grid: #e2e8f0; 
      --shadow-color: rgba(0, 0, 0, 0.1);
      
      --neon-green-glow: 0 0 5px rgba(16, 185, 129, 0.3);
      --neon-red-glow: 0 0 5px rgba(239, 68, 68, 0.3);
      
      --font-main: "Vazirmatn", system-ui, sans-serif;
    }

    [data-theme="dark"] {
      /* Dark Theme Variables */
      --primary: #6366f1;
      --secondary: #38bdf8;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
      --dark: #f1f5f9; 
      --muted: #94a3b8;
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --border: #334155;
      --chart-grid: #334155;
      --shadow-color: rgba(0, 0, 0, 0.5);
      
      --neon-green-glow: 0 0 15px rgba(52, 211, 153, 0.6);
      --neon-red-glow: 0 0 15px rgba(248, 113, 113, 0.6);
    }

    * { box-sizing: border-box; outline: none; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }

    body {
      margin: 0;
      font-family: var(--font-main);
      background-color: var(--bg-body);
      color: var(--dark);
      line-height: 1.5;
      overflow-x: hidden;
    }

    .container {
      max-width: 1440px; 
      margin: 0 auto;
      padding: 0 24px 60px;
    }

    /* --- HEADER --- */
    header {
      background: var(--bg-card);
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .header-inner {
        display: flex; justify-content: space-between; align-items: center;
        max-width: 1440px; margin: 0 auto; padding: 0 24px;
    }
    .logo-box { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; background: transparent; }
    .logo-img { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
    .header-titles { text-align: center; }
    h1 { font-size: 1.6rem; font-weight: 900; margin: 0; color: var(--dark); letter-spacing: -0.5px; }
    h2 { font-size: 0.9rem; font-weight: 500; color: var(--muted); margin: 4px 0 0; }

    /* --- PROJECT INFO BOX --- */
    .project-info {
        background: var(--bg-card); border-radius: 16px; padding: 20px;
        margin-bottom: 24px; border: 1px solid var(--border);
        box-shadow: 0 4px 6px -1px var(--shadow-color);
        display: flex; flex-direction: column; gap: 16px; position: relative; overflow: hidden;
    }
    .project-info::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        background: linear-gradient(to bottom, var(--primary), var(--secondary));
    }
    .info-header-row { display: flex; justify-content: space-between; align-items: flex-start; }
    .info-text { font-size: 0.95rem; color: var(--dark); text-align: justify; line-height: 1.8; flex: 1; margin-left: 20px; }
    
    .info-tags { display: flex; flex-wrap: wrap; gap: 12px; padding-top: 8px; align-items: center; }
    .tag {
        display: flex; align-items: center; gap: 6px; background: var(--bg-body); padding: 6px 12px; border-radius: 8px;
        font-size: 0.85rem; font-weight: 600; color: var(--muted); border: 1px solid transparent;
    }
    [data-theme="dark"] .tag { border-color: var(--border); }
    .tag i { color: var(--primary); }
    .tag b { color: var(--dark); margin-right: 4px; }

    .theme-toggle {
        background: var(--bg-body); border: 1px solid var(--border); color: var(--primary); padding: 6px 14px; border-radius: 8px;
        cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: var(--font-main); font-weight: 600; font-size: 0.85rem;
        box-shadow: 0 2px 4px var(--shadow-color); transition: all 0.2s; margin-right: auto;
    }
    .theme-toggle:hover { background: var(--border); transform: translateY(-1px); }

    /* --- ACCORDIONS --- */
    .layout-accordion {
        background: var(--bg-card); border-radius: 16px; margin-bottom: 24px; border: 1px solid var(--border);
        box-shadow: 0 4px 6px -1px var(--shadow-color); overflow: hidden; transition: border-color 0.3s;
    }
    .layout-accordion:hover { border-color: var(--primary); }
    .layout-header {
        padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; background: var(--bg-card); transition: background-color 0.2s; user-select: none;
    }
    .layout-header:hover { background-color: var(--bg-body); }
    .layout-title { font-weight: 800; color: var(--dark); font-size: 1.05rem; display: flex; align-items: center; gap: 10px; }
    .layout-arrow { color: var(--muted); transition: transform 0.4s ease; font-size: 1.1rem; }
    .layout-arrow.open { transform: rotate(180deg); color: var(--primary); }
    
    .layout-content { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.5s ease-in-out; background: var(--bg-body); border-top: 1px solid transparent; }
    .layout-content.open { max-height: 2500px; opacity: 1; border-top-color: var(--border); padding-bottom: 20px; }
    
    .layout-inner { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    .layout-img { max-width: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border); max-height: 600px; object-fit: contain; background: #fff; align-self: center;}
    .info-list { display: flex; flex-direction: column; gap: 12px; }
    .info-row { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .info-row:last-child { border-bottom: none; }
    .info-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 6px; font-weight: bold; }
    .info-desc-box { background: var(--bg-body); border: 1px solid var(--border); padding: 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.7; color: var(--dark); }

    /* --- CONTROLS: BASE STYLES --- */
    .controls-wrapper { position: sticky; top: 10px; z-index: 100; margin-bottom: 40px; width: 100%; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .controls { background: transparent; border: 1px solid transparent; border-radius: 24px; padding: 10px 0; box-shadow: none; position: relative; width: 100%; transition: all 0.4s ease;}
    .ctrl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .ctrl-title { font-weight: 800; color: var(--dark); display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
    
    .btn-reset {
      font-family: var(--font-main); background: var(--bg-card); color: var(--muted); border: 1px solid var(--border);
      padding: 8px 16px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 5px var(--shadow-color);
    }
    .btn-reset:hover { background: var(--primary); color: #fff; border-color: var(--primary); transform: translateY(-1px); }

    .ctrl-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; }
    .ctrl-item { position: relative; padding: 20px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); box-shadow: 0 4px 6px -1px var(--shadow-color); transition: 0.3s; display: flex; flex-direction: column; justify-content: center; flex: 1; }
    .ctrl-item:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px var(--shadow-color); border-color: var(--primary); }
    
    .ctrl-bg-icon { position: absolute; left: 16px; bottom: 8px; font-size: 4rem; opacity: 0.08; pointer-events: none; transition: 0.3s; color: var(--dark); }
    .ctrl-label { display: flex; justify-content: space-between; font-weight: 700; font-size: 0.95rem; margin-bottom: 16px; color: var(--dark); position: relative; z-index: 2; }
    .val-tag { font-family: var(--font-main); font-size: 0.95rem; direction: ltr; background: transparent; border: none; padding: 0; color: var(--dark); font-weight: 800; }

    /* --- RESPONSIVE CONTROL LOGIC (THE 3-TIER SYSTEM) --- */
    
    /* 1. Base / Desktop Hidden Elements */
    .tablet-toggle-header, .mobile-fab, .bottom-sheet-overlay, .mobile-close-btn, .alt-reset-btn { display: none !important; }
    .tablet-collapsible { display: block; width: 100%; }

    /* Advanced iOS Glassmorphism for Expanded state */
    .controls-wrapper.compact { top: 20px; display: flex; justify-content: center; }
    .controls-wrapper.compact .controls {
        width: 96%; max-width: 1400px; padding: 16px 24px;
        background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(50px) saturate(200%); -webkit-backdrop-filter: blur(50px) saturate(200%);
        border: 1px solid rgba(255, 255, 255, 0.4); border-top-color: rgba(255, 255, 255, 0.8); border-radius: 24px; 
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,1); display: flex; flex-direction: column; gap: 16px; 
    }
    [data-theme="dark"] .controls-wrapper.compact .controls {
        background: rgba(15, 23, 42, 0.3); border-color: rgba(255, 255, 255, 0.1); border-top-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .controls-wrapper.compact .ctrl-header { margin: 0; width: 100%; justify-content: space-between; flex: 0 0 auto; margin-bottom: 0;}
    .controls-wrapper.compact .ctrl-title span { display: block; font-size: 1.1rem; text-shadow: 0 1px 2px rgba(255,255,255,0.5);} 
    [data-theme="dark"] .controls-wrapper.compact .ctrl-title span { text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    
    .controls-wrapper.compact .ctrl-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; width: 100%; }
    .controls-wrapper.compact .ctrl-item { background: rgba(255,255,255, 0.35); padding: 10px 14px; margin: 0; border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 12px; flex-direction: column; align-items: stretch; gap: 8px; flex: 1; }
    [data-theme="dark"] .controls-wrapper.compact .ctrl-item { background: rgba(0, 0, 0, 0.2); border-color: rgba(255,255,255,0.05); box-shadow: none; }
    .controls-wrapper.compact .ctrl-item:hover { transform: translateY(-1px); background: rgba(255,255,255, 0.5); }
    [data-theme="dark"] .controls-wrapper.compact .ctrl-item:hover { background: rgba(255,255,255, 0.05); }
    .controls-wrapper.compact .ctrl-bg-icon { display: none; }
    .controls-wrapper.compact .ctrl-label { margin: 0; width: 100%; font-size: 0.85rem; margin-bottom: 0; }
    .controls-wrapper.compact input[type="range"] { margin: 0; width: 100%; height: 6px; }

    /* 2. TABLET: Collapsible Sticky Header (481px - 850px) */
    @media (min-width: 481px) and (max-width: 850px) {
        .desktop-header { display: none !important; }
        .tablet-toggle-header { display: flex !important; justify-content: space-between; align-items: center; cursor: pointer; width: 100%; }
        
        .tablet-collapsible { max-height: 0; overflow: hidden; transition: max-height 0.4s ease, padding 0.4s ease; opacity: 0; }
        .tablet-collapsible.open { max-height: 800px; opacity: 1; padding-top: 16px; border-top: 1px solid rgba(148, 163, 184, 0.2); margin-top: 12px; }
        
        .controls-wrapper.compact .controls { flex-direction: column !important; padding: 12px 24px; border-radius: 20px;}
        .ctrl-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .alt-reset-btn { display: flex !important; width: 100%; justify-content: center; margin-top: 16px; }
    }

    /* 3. MOBILE: Bottom Sheet Modal (<= 480px) */
    @media (max-width: 480px) {
        .tablet-toggle-header { display: none !important; }
        .desktop-header { display: flex !important; width: 100%; border-bottom: 1px solid var(--border); padding-bottom: 16px; margin-bottom: 16px !important; }
        .desktop-reset-btn { display: none !important; }
        .mobile-close-btn { display: block !important; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 4px;}
        .alt-reset-btn { display: flex !important; width: 100%; justify-content: center; margin-top: 16px; padding: 12px;}
        
        .tablet-collapsible { display: block !important; max-height: none !important; opacity: 1 !important; }
        
        /* Modal Positioning */
        .controls-wrapper { position: fixed !important; top: auto !important; bottom: -120%; left: 0; right: 0; width: 100%; z-index: 1000; transition: bottom 0.4s cubic-bezier(0.3, 1, 0.3, 1); margin: 0 !important; }
        .controls-wrapper.sheet-open { bottom: 0; }
        
        .controls {
            width: 100% !important; max-width: 100% !important; border-radius: 24px 24px 0 0 !important;
            padding: 24px !important; background: var(--bg-card) !important; backdrop-filter: none !important; 
            border: none !important; box-shadow: 0 -10px 40px rgba(0,0,0,0.3) !important;
            display: flex; flex-direction: column; max-height: 85vh; overflow-y: auto;
        }
        [data-theme="dark"] .controls { background: var(--bg-body) !important; box-shadow: 0 -10px 40px rgba(0,0,0,0.8) !important; }
        
        .ctrl-grid { grid-template-columns: 1fr; gap: 12px; }
        .ctrl-item { background: var(--bg-body) !important; border-color: var(--border) !important; flex-direction: column !important; align-items: stretch !important; padding: 16px !important; box-shadow: none !important;}
        .ctrl-label { margin-bottom: 12px !important; flex: 1; font-size: 0.9rem; }
        input[type=range] { width: 100% !important; margin: 0 !important; }

        /* FAB Button */
        .mobile-fab {
            display: flex !important; position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 900;
            background: var(--primary); color: #fff; border: none; padding: 14px 28px; border-radius: 99px;
            font-family: var(--font-main); font-weight: 800; font-size: 1.05rem; align-items: center; gap: 10px;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.5); cursor: pointer; transition: 0.2s; white-space: nowrap;
        }
        
        /* Backdrop Overlay */
        .bottom-sheet-overlay { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(2px); }
        .bottom-sheet-overlay.show { opacity: 1; visibility: visible; }
    }

    /* Sliders */
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: var(--border); border-radius: 99px; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
      background: var(--bg-card); border: 4px solid var(--muted); margin-top: -7px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: transform 0.1s;
    }
    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.15); }
    #revRange::-webkit-slider-thumb { border-color: var(--success); }
    #costRange::-webkit-slider-thumb { border-color: var(--danger); }
    #discRange::-webkit-slider-thumb { border-color: var(--warning); }
    #periodRange::-webkit-slider-thumb { border-color: var(--primary); }
    #infRange::-webkit-slider-thumb { border-color: var(--secondary); }

    /* --- KPI CARDS & TOOLTIP --- */
    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
    @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 850px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .kpi-grid { grid-template-columns: 1fr; } }

    .kpi-card {
      background: var(--bg-card); border-radius: 14px; padding: 16px; position: relative;
      box-shadow: 0 2px 4px var(--shadow-color); border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s; min-height: 110px; display: flex; flex-direction: column; justify-content: space-between;
    }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px var(--shadow-color); z-index: 10; }
    .kpi-card:not(.irr-anim-card):not(.real-irr-card)::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--color); border-top-left-radius: 14px; border-top-right-radius: 14px;
    }

    .kpi-bg-icon-wrapper { position: absolute; inset: 0; overflow: hidden; border-radius: 14px; pointer-events: none; z-index: 0; }
    .kpi-bg-icon { position: absolute; bottom: -12px; left: -8px; font-size: 4.5rem; opacity: 0.15; color: var(--color); transform: rotate(10deg); }
    
    .info-tooltip { position: relative; cursor: help; display: inline-flex; align-items: center; }
    .info-tooltip::after {
        content: attr(data-tooltip); position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.95); color: #fff; padding: 10px 14px; border-radius: 10px;
        font-size: 0.8rem; font-weight: normal; white-space: nowrap; font-family: var(--font-main);
        opacity: 0; visibility: hidden; transition: 0.2s ease-in-out; z-index: 9999; box-shadow: 0 10px 25px rgba(0,0,0,0.3); pointer-events: none;
    }
    .info-tooltip::before {
        content: ''; position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%);
        border-width: 6px; border-style: solid; border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
        opacity: 0; visibility: hidden; transition: 0.2s ease-in-out; z-index: 9999;
    }
    .info-tooltip:hover::after, .info-tooltip:hover::before { opacity: 1; visibility: visible; bottom: 145%; }
    .info-tooltip:hover::before { bottom: 115%; }

    /* Animations for IRR Cards */
    .irr-anim-card { background: transparent !important; border: none !important; }
    .anim-glow { position: absolute; inset: 0; border-radius: 14px; overflow: hidden; z-index: 0; pointer-events: none; }
    .anim-glow::before {
        content: ''; position: absolute; left: -50%; top: -50%; width: 200%; height: 200%;
        background-image: conic-gradient(transparent, transparent, transparent, var(--anim-color)); animation: rotate 3s linear infinite; z-index: 1;
    }
    .anim-glow::after { content: ''; position: absolute; inset: 3px; background: var(--bg-card); border-radius: 11px; z-index: 2; }

    .real-irr-card { border: 1px solid var(--border); }
    .radar-bg-container { position: absolute; inset: 0; border-radius: 14px; overflow: hidden; z-index: 0; pointer-events: none; }
    .radar-sweep { position: absolute; left: -50%; top: -50%; width: 200%; height: 200%; background-image: conic-gradient(transparent, transparent, transparent, var(--anim-color)); opacity: 0.25; animation: rotate 3s linear infinite; }
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    
    .kpi-top, .kpi-val, .kpi-sub { z-index: 3; position: relative;}
    .kpi-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .kpi-title { font-size: 0.8rem; color: var(--muted); font-weight: 700; display:flex; align-items:center; gap:6px;}
    .kpi-val { font-size: 1.4rem; font-weight: 800; color: var(--dark); margin-top: 6px; line-height: 1.2; }
    .kpi-sub { font-size: 0.75rem; color: var(--color); margin-top: 6px; font-weight: 600; display: flex; align-items: center; gap: 4px; }

    /* --- CHARTS --- */
    .charts-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
    @media (max-width: 1024px) { .charts-wrapper { grid-template-columns: 1fr !important; } }
    .chart-box { background: var(--bg-card); border-radius: 20px; padding: 24px; border: 1px solid var(--border); box-shadow: 0 4px 6px var(--shadow-color); min-width: 0; display: flex; flex-direction: column; }
    .chart-header { display: flex; justify-content: space-between; margin-bottom: 16px; align-items: center; }
    .chart-title { font-size: 1rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 8px; }
    .chart-body { position: relative; height: 320px; width: 100%; flex: 1;}
    .chart-body-sm { position: relative; height: 280px; width: 100%; }

    /* --- 3-TIER RESPONSIVE MATRIX --- */
    .matrix-container { width: 100%; margin-top: 30px; background: var(--bg-card); border-radius: 20px; padding: 24px; border: 1px solid var(--border); box-shadow: 0 4px 6px var(--shadow-color); }
    .matrix-scroll { overflow-x: auto; padding-bottom: 10px; }
    
    .matrix-container table { width: 100%; min-width: 800px; border-collapse: separate; border-spacing: 6px; }
    .matrix-container th { font-size: 0.85rem; color: var(--muted); padding: 12px; font-weight: 600; background: var(--bg-body); border-radius: 8px; border: 1px solid var(--border); }
    .matrix-container td { padding: 14px; text-align: center; border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: default; transition: 0.1s; border: 2px solid transparent; }
    .matrix-container td:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 10; border-color: var(--dark); }
    .matrix-cell { position: relative; }
    
    /* MATRIX COLORS - ENHANCED CONTRAST READABILITY */
    .bg-green { background-color: rgba(16, 185, 129, 0.15) !important; color: #047857 !important; box-shadow: var(--neon-green-glow); }
    .bg-orange { background-color: rgba(245, 158, 11, 0.15) !important; color: #b45309 !important; }
    .bg-red { background-color: rgba(239, 68, 68, 0.15) !important; color: #b91c1c !important; box-shadow: var(--neon-red-glow); }

    [data-theme="dark"] .bg-green { color: #34d399 !important; }
    [data-theme="dark"] .bg-orange { color: #fbbf24 !important; }
    [data-theme="dark"] .bg-red { color: #f87171 !important; }

    /* Tier 2: Tablets & Standard Mobile (Adaptive Size) */
    @media (max-width: 768px) {
        .matrix-container table { min-width: 100%; border-spacing: 4px; }
        .matrix-container th { padding: 8px 4px; font-size: 0.75rem; }
        .matrix-container td { padding: 12px 4px; font-size: 0.85rem; border-radius: 8px;}
    }

    /* Tier 3: Very Small Mobile (Interactive Heatmap) */
    @media (max-width: 480px) {
        .matrix-container { padding: 16px 12px; }
        .matrix-container table { border-spacing: 3px; }
        .matrix-container th { padding: 6px 2px; font-size: 0.65rem; }
        .matrix-container td { 
            color: transparent !important; /* Hide the text for heatmap effect */
            padding: 16px 2px; font-size: 0; border-radius: 6px;
        }
        .matrix-container td:hover { transform: scale(1.05); }

        /* Heatmap Tooltip on Tap */
        .matrix-cell:active::after, .matrix-cell:hover::after {
            content: attr(data-val); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95); color: #fff; padding: 6px 10px; border-radius: 6px;
            font-size: 0.85rem; font-weight: bold; z-index: 999; pointer-events: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .matrix-cell:active::before, .matrix-cell:hover::before {
            content: ''; position: absolute; bottom: calc(100% - 6px); left: 50%; transform: translateX(-50%);
            border-width: 6px; border-style: solid; border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
            z-index: 999; pointer-events: none;
        }
    }

    footer { text-align: center; color: var(--muted); font-size: 0.85rem; margin-top: 50px; opacity: 0.9; padding-bottom: 20px; }
    .sep-link { color: var(--primary); font-weight: 700; text-decoration: none; position: relative; cursor: pointer; border-bottom: 1px dashed var(--primary); }
    .sep-link:hover::after {
        content: attr(data-hover); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
        background: var(--dark); color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; white-space: pre-wrap; width: max-content; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); pointer-events: none; z-index: 100;
    }
    .dir-ltr { direction: ltr; display: inline-block; }
  </style>
</head>
<body>

  <div class="bottom-sheet-overlay" id="bsOverlay" onclick="closeBottomSheet()"></div>

  <button class="mobile-fab" onclick="openBottomSheet()">
      <i class="fa-solid fa-sliders"></i> تنظیمات داشبورد
  </button>

  <header>
    <div class="header-inner">
        <div class="logo-box">
            <img src="https://uploadkon.ir/uploads/3cf714_25AnbarLlogo.png" alt="کارفرما" class="logo-img">
        </div>
        <div class="header-titles">
            <h1>داشبورد امکان‌سنجی فنی-اقتصادی</h1>
            <h2>انبار 2240 متری | پهنه لجستیک منطقه آزاد شهر فرودگاهی امام خمینی (ره)</h2>
        </div>
        <div class="logo-box">
            <img src="https://uploadkon.ir/uploads/70c214_25sepiLogoo.png" alt="مشاور" class="logo-img">
        </div>
    </div>
  </header>

  <div class="container">

    <div class="project-info">
        <div class="info-header-row">
            <div class="info-text">
                پروژه احداث انبار ۲۲۴۰ مترمربعی در اراضی پهنه لجستیک هسته پیشران منطقه آزاد شهر فرودگاهی امام خمینی (ره)، یک طرح توسعه‌ای «زودبازده» و «استراتژیک» جهت پاسخگویی فوری به تقاضای انباشته بازار برای انبارش کالاهای سنگین و صنعتی است. این طرح با بهره‌گیری هوشمندانه از زیرساخت موجود و اجرای سازه‌ای مهندسی‌شده (بدون ستون و با ارتفاع ۹ متر)، ضمن کاهش چشمگیر هزینه‌های ساخت (CAPEX) و دوره اجرا (۱ سال)، گلوگاه عملیاتی فعلی در انبارش کالاهای رسوبی را رفع نموده و با تبدیل دارایی‌های راکد به یک ترمینال لجستیک استاندارد، جریان درآمدی پایدار و حاشیه سود جذابی را برای شرکت ایجاد می‌نماید.
            </div>
        </div>
        <div class="info-tags">
            <div class="tag"><i class="fa-solid fa-clock"></i> دوران ساخت: <b>۱ سال</b></div>
            <div class="tag"><i class="fa-solid fa-calendar-check"></i> دوران بهره‌برداری: <b>متغیر</b></div>
            <div class="tag"><i class="fa-solid fa-percent"></i> نرخ تنزیل پایه: <b>۳۵٪</b></div>
            <div class="tag" style="border-color:var(--success); color:var(--success);"><i class="fa-solid fa-wrench"></i> با «گیره‌ها» می‌توانید درآمد، هزینه، دوران و نرخ تورم را تغییر دهید.</div>
            
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fa-solid fa-circle-half-stroke"></i> تغییر تم روشن و تاریک
            </button>
        </div>
    </div>

    <div class="layout-accordion">
        <div class="layout-header" onclick="toggleAccordion('layout')">
            <span class="layout-title"><i class="fa-solid fa-map-location-dot" style="color:var(--secondary)"></i> جانمایی انبار سوله 2240 مترمربعی</span>
            <i class="fa-solid fa-chevron-down layout-arrow" id="layoutArrow"></i>
        </div>
        <div class="layout-content" id="layoutContent">
            <div class="layout-inner"><img src="https://uploadkon.ir/uploads/74fb14_25Anbar22400.jpeg" alt="جانمایی انبار" class="layout-img"></div>
        </div>
    </div>

    <div class="layout-accordion">
        <div class="layout-header" onclick="toggleAccordion('evo')">
            <span class="layout-title"><i class="fa-solid fa-chart-line" style="color:var(--success)"></i> مقایسه تطبیقی و تحول عملکرد عملیاتی (۱۴۰۱ تا ۱۴۰۴)</span>
            <i class="fa-solid fa-chevron-down layout-arrow" id="evoArrow"></i>
        </div>
        <div class="layout-content" id="evoContent">
            <div class="layout-inner">
                <div class="charts-wrapper" style="grid-template-columns: 2fr 1fr; margin-bottom: 0;">
                    <div class="chart-box">
                        <div class="chart-header"><div class="chart-title"><i class="fa-solid fa-arrow-trend-up" style="color:var(--warning)"></i> روند رشد نمایی تناژ ورودی</div></div>
                        <div class="chart-body"><canvas id="growthChart"></canvas></div>
                    </div>
                    <div class="chart-box" style="justify-content: center;">
                        <div class="info-list">
                            <div class="info-row"><span style="font-weight: 800; color: var(--dark)">سال ۱۴۰۱</span><span style="color: var(--muted); font-size: 0.9rem">۱۷۱ تن <span style="font-size: 0.75rem; opacity: 0.7">(تثبیت زیرساخت‌ها)</span></span></div>
                            <div class="info-row"><span style="font-weight: 800; color: var(--dark)">سال ۱۴۰۲</span><div style="display: flex; align-items: center; gap: 10px;"><span class="info-badge" style="background: rgba(16, 185, 129, 0.15); color: var(--success);">رشد ۱,۱۴۹٪</span><span style="font-weight: 800; color: var(--secondary); font-size: 1.1rem; width: 60px; text-align: left;">۲,۱۴۴ تن</span></div></div>
                            <div class="info-row"><span style="font-weight: 800; color: var(--dark)">سال ۱۴۰۳</span><div style="display: flex; align-items: center; gap: 10px;"><span class="info-badge" style="background: rgba(16, 185, 129, 0.15); color: var(--success);">رشد ۲۴۸٪</span><span style="font-weight: 800; color: var(--secondary); font-size: 1.1rem; width: 60px; text-align: left;">۷,۴۸۲ تن</span></div></div>
                            <div class="info-row" style="border-bottom: none;"><span style="font-weight: 800; color: var(--dark)">سال ۱۴۰۴ <span style="font-size: 0.75rem; font-weight: normal; color: var(--muted)">(۹ ماهه)</span></span><div style="display: flex; align-items: center; gap: 10px;"><span class="info-badge" style="background: rgba(245, 158, 11, 0.15); color: var(--warning);">رشد ۹۳٪</span><span style="font-weight: 800; color: var(--warning); font-size: 1.2rem; width: 60px; text-align: left;">۱۴,۴۵۰ تن</span></div></div>
                        </div>
                        <div class="info-desc-box" style="margin-top: 16px;"><strong style="color: var(--secondary); display: block; margin-bottom: 4px;">تحلیل استراتژیک:</strong>عملکرد مجموعه هر سال به طور میانگین بیش از ۲ برابر شده است که نشان‌دهنده روند مستمر و پایدار در جذب تقاضای بازار است.</div>
                    </div>
                </div>
                <div class="charts-wrapper" style="grid-template-columns: 1fr 1fr; margin-bottom: 0;">
                    <div class="chart-box">
                        <div class="chart-header"><div class="chart-title"><i class="fa-solid fa-boxes-stacked" style="color:var(--primary)"></i> تغییر ماهیت و الگوی کالا</div></div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div class="info-desc-box" style="border-right: 4px solid var(--muted);"><h4 style="font-weight: bold; margin: 0 0 6px 0; color: var(--dark);">دوره اول (۱۴۰۱ - ۱۴۰۲)</h4><p style="margin:0;">تمرکز سیستم بر کالاهای عمومی (General Cargo)، اقلام خرد و قطعات با تناژ پایین.</p></div>
                            <div class="info-desc-box" style="border-right: 4px solid var(--primary); background: rgba(79, 70, 229, 0.05);"><h4 style="font-weight: bold; margin: 0 0 6px 0; color: var(--primary);">دوره دوم (۱۴۰۳ - ۱۴۰۴)</h4><p style="margin:0;">شیفت استراتژیک به سمت کالاهای سرمایه‌ای. در سال ۱۴۰۴، بیش از <strong style="background: rgba(79, 70, 229, 0.1); padding: 0 4px; border-radius: 4px;">۹۰٪ وزن کالاها (حدود ۱۳ هزار تن)</strong> را اقلام «سنگین و فوق‌سنگین» تشکیل داده‌اند.</p></div>
                        </div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-header"><div class="chart-title"><i class="fa-solid fa-gauge-high" style="color:#14b8a6"></i> ارتقای شاخص‌های بهره‌وری</div></div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(20, 184, 166, 0.1); padding: 16px; border-radius: 12px; margin-bottom: 12px; border: 1px solid rgba(20, 184, 166, 0.2);">
                            <div><div style="font-weight: bold; font-size: 1.1rem; color: #0f766e;">بهینه‌سازی نرخ گردش</div><div style="font-size: 0.85rem; color: #0f766e;">کاهش میانگین ماندگاری کالا</div></div>
                            <div style="display: flex; align-items: center; gap: 10px; background: var(--bg-card); padding: 8px 16px; border-radius: 8px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"><span style="color: var(--muted); text-decoration: line-through; font-size: 1.1rem;">۱۵۸ روز</span><span style="color: #14b8a6;">➔</span><span style="color: #0f766e; font-size: 1.3rem;">۴۹ روز</span></div>
                        </div>
                        <div class="info-desc-box"><strong style="color: var(--warning); display: block; margin-bottom: 4px;">تغییر الگوی درآمدزایی:</strong>تغییر مدل کسب‌وکار از «درآمد رسوب کالا» به «درآمد گردش عملیات». افزایش سهم درآمدی خدمات تخلیه و بارگیری با لیفتراک‌های سنگین.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="layout-accordion">
        <div class="layout-header" onclick="toggleAccordion('cargo')">
            <span class="layout-title"><i class="fa-solid fa-weight-hanging" style="color:var(--danger)"></i> پروفایل کالا: شیفت به سمت سنگین‌بار</span>
            <i class="fa-solid fa-chevron-down layout-arrow" id="cargoArrow"></i>
        </div>
        <div class="layout-content" id="cargoContent">
            <div class="layout-inner">
                <p style="color: var(--muted); font-size: 0.95rem; margin-top: 0;">بیش از ۹۰٪ حجم بار فعلی شامل کالاهای سنگین و فوق‌سنگین است. این تغییر ماهیت، نیاز به فضای مسقف با کف‌سازی صنعتی و بدون قفسه‌بندی (Racking) را دیکته می‌کند.</p>
                <div class="charts-wrapper" style="grid-template-columns: 1fr 1fr; margin-bottom: 0;">
                    <div class="chart-box"><div class="chart-header"><div class="chart-title">توزیع وزنی کالاها</div></div><div class="chart-body"><canvas id="weightDonutChart"></canvas></div></div>
                    <div class="chart-box"><div class="chart-header"><div class="chart-title">مقایسه سهم وزنی و درآمدی</div></div><div class="chart-body"><canvas id="revenueBarChart"></canvas></div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls-wrapper" id="controlPanel">
      <div class="controls">
        
        <div class="tablet-toggle-header" onclick="toggleTabletControls()">
            <div class="ctrl-title"><i class="fa-solid fa-sliders" style="color:var(--primary)"></i> <span>تنظیمات داشبورد (باز کردن)</span></div>
            <i class="fa-solid fa-chevron-down layout-arrow" id="tabletCtrlArrow" style="transition:0.4s"></i>
        </div>

        <div class="ctrl-header desktop-header">
          <div class="ctrl-title"><i class="fa-solid fa-sliders" style="color:var(--primary)"></i> <span>تنظیمات داشبورد</span></div>
          <i class="fa-solid fa-times mobile-close-btn" onclick="closeBottomSheet()"></i>
          <button class="btn-reset desktop-reset-btn" onclick="resetDefaults()"><i class="fa-solid fa-rotate-right"></i> <span>بازنشانی</span></button>
        </div>
        
        <div class="tablet-collapsible" id="tabletCollapsible">
            <div class="ctrl-grid">
               <div class="ctrl-item"><div class="ctrl-label"><span>تغییر درآمدها</span><span class="val-tag" id="revVal">0%</span></div><input type="range" id="revRange" min="-50" max="50" step="1" value="0"></div>
               <div class="ctrl-item"><div class="ctrl-label"><span>تغییر هزینه‌ها</span><span class="val-tag" id="costVal">0%</span></div><input type="range" id="costRange" min="-50" max="50" step="1" value="0"></div>
               <div class="ctrl-item"><div class="ctrl-label"><span>نرخ تنزیل</span><span class="val-tag val-neu" id="discVal">35%</span></div><input type="range" id="discRange" min="0" max="100" step="1" value="35"></div>
               <div class="ctrl-item"><div class="ctrl-label"><span>دوران بهره‌برداری</span><span class="val-tag val-neu" id="periodVal">10 سال</span></div><input type="range" id="periodRange" min="2" max="10" step="1" value="10"></div>
               <div class="ctrl-item"><div class="ctrl-label"><span>نرخ تورم</span><span class="val-tag val-neu" id="infVal">53%</span></div><input type="range" id="infRange" min="10" max="100" step="1" value="53"></div>
            </div>
            <button class="btn-reset alt-reset-btn" onclick="resetDefaults()"><i class="fa-solid fa-rotate-right"></i> <span>بازنشانی تنظیمات</span></button>
        </div>
      </div>
    </div>

    <div class="kpi-grid" id="kpiContainer"></div>

    <div class="charts-wrapper">
        <div class="chart-box"><div class="chart-header"><div class="chart-title"><i class="fa-solid fa-chart-column" style="color:var(--secondary)"></i> جریان نقدینگی (Cash Flow)</div></div><div class="chart-body"><canvas id="cashChart"></canvas></div></div>
        <div class="chart-box"><div class="chart-header"><div class="chart-title"><i class="fa-solid fa-chart-pie" style="color:var(--warning)"></i> ساختار هزینه ثابت</div></div><div class="chart-body"><canvas id="costChart"></canvas></div></div>
    </div>

    <div class="charts-wrapper" style="grid-template-columns: 1fr;">
        <div class="chart-box"><div class="chart-header"><div class="chart-title"><i class="fa-solid fa-crosshairs" style="color:var(--danger)"></i> تحلیل نقطه سربه‌سر (بازگشت سرمایه)</div></div><div class="chart-body-sm"><canvas id="beChart"></canvas></div></div>
    </div>
    
    <div class="matrix-container">
        <div class="chart-header">
            <div class="chart-title"><i class="fa-solid fa-table-cells" style="color:var(--primary)"></i> ماتریس تحلیل حساسیت (IRR)</div>
            <div style="font-size:0.85rem; color:var(--muted)">رنگ‌بندی بر اساس نرخ تنزیل انتخابی (قرمز < نرخ | سبز > نرخ+۵٪)</div>
        </div>
        <div class="matrix-scroll">
            <table id="matrixTable"></table>
        </div>
    </div>

    <footer>
        <p>تهیه شده در <span class="sep-link" data-hover="تحلیل و طراحی: حمیدرضا ترابی&#10;hr.torabii@gmail.com">موسسه سپینود تدبیر</span> - پاییز 1404</p>
    </footer>

  </div>

  <script>
    function toggleTheme() {
        const html = document.documentElement;
        html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        updateChartsTheme();
    }

    function toggleAccordion(id) {
        const content = document.getElementById(id + 'Content');
        const arrow = document.getElementById(id + 'Arrow');
        content.classList.toggle('open');
        arrow.classList.toggle('open');
    }

    // --- Tablet Toggle Controls Logic ---
    function toggleTabletControls() {
        const coll = document.getElementById('tabletCollapsible');
        const arrow = document.getElementById('tabletCtrlArrow');
        coll.classList.toggle('open');
        arrow.style.transform = coll.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    // --- Mobile Bottom Sheet Logic ---
    function openBottomSheet() {
        document.getElementById('controlPanel').classList.add('sheet-open');
        document.getElementById('bsOverlay').classList.add('show');
        document.body.style.overflow = 'hidden'; // Stop background scroll
    }

    function closeBottomSheet() {
        document.getElementById('controlPanel').classList.remove('sheet-open');
        document.getElementById('bsOverlay').classList.remove('show');
        document.body.style.overflow = '';
    }

    const BASE = {
        years: ["سال 1", "سال 2", "سال 3", "سال 4", "سال 5", "سال 6", "سال 7", "سال 8", "سال 9", "سال 10"],
        revenue: [0, 278684, 672813, 1406437, 2151848, 3292328, 5037262, 7707011, 11791727, 18012204], 
        expense: [796631, 295193, 451645, 691017, 1057256, 1617602, 2474931, 3786645, 5793567, 8835019],
        depreciation: [0, 98689, 150993, 231020, 353461, 540795, 827416, 1265946, 1936898, 2963454],
        capex: 791236,
        capexParts: [466143, 41650, 137230, 2500, 11840, 98904, 32968],
        capexLabels: ['عملیات احداث', 'تأسیسات', 'تجهیزات', 'اداری و رفاهی', 'قبل از بهره‌برداری', 'بالاسری', 'پیش‌بینی نشده']
    };

    const fmt = new Intl.NumberFormat('fa-IR');
    const el = id => document.getElementById(id);

    window.addEventListener('scroll', () => {
        if(window.innerWidth > 480) {
            const p = el('controlPanel');
            if(window.scrollY > 150) p.classList.add('compact');
            else p.classList.remove('compact');
        }
    });

    // Handle Window Resize for Matrix & Controls Layout
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            update(); // Refresh matrix steps based on width
            if(window.innerWidth > 480) closeBottomSheet();
        }, 150);
    });

    function calcMetrics(rPct, cPct, dRate, limit = 10, infRate = 53) {
        const rMult = 1 + rPct/100;
        const cMult = 1 + cPct/100;
        const rate = dRate/100;
        const baseInf = 0.53;
        const newInf = infRate / 100;

        let annualNet = [], cumCash = [], cumDisc = [], fcfArr = [], annualRev = [], annualExp = [];
        let tRev = 0, tExp = 0, runCum = 0, runDisc = 0, pvRev = 0, pvExp = 0;

        for(let i=0; i < limit; i++) {
            const infMultiplier = Math.pow((1 + newInf) / (1 + baseInf), i);
            const r = BASE.revenue[i] * rMult * infMultiplier;
            const c = BASE.expense[i] * cMult * infMultiplier;
            const net = r - c;
            const fcf = net + BASE.depreciation[i];
            
            annualRev.push(r); annualExp.push(c); annualNet.push(fcf); fcfArr.push(fcf);
            tRev += r; tExp += c;
            runCum += fcf; cumCash.push(runCum);
            const df = Math.pow(1+rate, i+1);
            runDisc += fcf/df; cumDisc.push(runDisc);
            pvRev += r/df; pvExp += c/df;
        }

        const npv = runDisc;
        const bc = pvRev / pvExp;
        const irr = getIRR(fcfArr);
        const realIrr = irr !== null ? ((1 + irr) / (1 + newInf)) - 1 : null;
        const pp = getPayback(fcfArr);
        const pbp = pp ? pp + 0.6 : null; 
        const bep = 2 * ((1+cPct/100) / (1+rPct/100));

        return { npv, irr, realIrr, bc, pp, pbp, bep, tRev, tExp, annualNet, cumCash, cumDisc, annualRev, annualExp };
    }

    function getIRR(vals) {
        let g = 0.1;
        for(let i=0; i<1000; i++) {
            let n=0, d=0;
            for(let t=0; t<vals.length; t++) {
                let div = Math.pow(1+g, t+1);
                n += vals[t]/div;
                d -= (t+1)*vals[t]/(div*(1+g));
            }
            let next = g - n/d;
            if(Math.abs(next-g)<1e-6) return next;
            g = next;
        }
        return null;
    }

    function getPayback(vals) {
        let cum = 0;
        for(let i=0; i<vals.length; i++) {
            let p = cum; cum += vals[i];
            if(p<0 && cum>=0) return i + Math.abs(p)/vals[i];
        }
        return null;
    }

    function renderKPIs(m, dRate, limit) {
        const irrVal = m.irr !== null ? Math.round(m.irr*100) : -100;
        const diff = irrVal - dRate;
        let irrAnimColor = '#ef4444'; 
        if(diff > 5) irrAnimColor = '#10b981'; else if(diff >= 0) irrAnimColor = '#f59e0b'; 
        let irrTxt = "ریسک بالا", irrC = "var(--danger)";
        if(diff > 5) { irrTxt = "بسیار جذاب"; irrC = "var(--success)"; } else if(diff >= 0) { irrTxt = "قابل قبول"; irrC = "var(--warning)"; }

        const realIrrVal = m.realIrr !== null ? Math.round(m.realIrr*100) : -100;
        let realIrrAnimColor = '#ef4444';
        if(realIrrVal >= 10) realIrrAnimColor = '#10b981'; else if(realIrrVal >= 0) realIrrAnimColor = '#f59e0b';
        let realIrrTxt = "نابودی سرمایه", realIrrC = "var(--danger)";
        if(realIrrVal >= 10) { realIrrTxt = "سودآوری واقعی"; realIrrC = "var(--success)"; } else if(realIrrVal >= 0) { realIrrTxt = "حفظ ارزش پول"; realIrrC = "var(--warning)"; }

        let npvTxt = "زیان‌ده", npvC = "var(--danger)";
        if(m.npv > 0) { npvTxt = "سودآور"; npvC = "var(--secondary)"; }

        const ppDisplay = (m.pp && m.pp <= limit) ? m.pp.toFixed(1) : `>${limit}`;
        const pbpDisplay = (m.pbp && m.pbp <= limit) ? m.pbp.toFixed(1) : `>${limit}`;

        const r1 = [
            { t: "سرمایه‌گذاری ثابت", v: fmt.format(BASE.capex), s: "میلیون ریال", c: "var(--muted)", i: "fa-warehouse" },
            { t: "مجموع ورودی", v: fmt.format(Math.round(m.tRev)), s: "میلیون ریال", c: "var(--success)", i: "fa-arrow-trend-up" },
            { t: "مجموع خروجی", v: fmt.format(Math.round(m.tExp)), s: "میلیون ریال", c: "var(--danger)", i: "fa-arrow-trend-down" },
            { t: "نسبت B/C", v: m.bc.toFixed(2), s: "شاخص کارایی", c: "var(--primary)", i: "fa-scale-balanced" }
        ];

        const irrItem = { t: "نرخ بازدهی داخلی (اسمی)", v: m.irr!==null ? (m.irr*100).toFixed(1)+"%" : "N/A", s: irrTxt, c: irrC, i: "fa-chart-pie", animColor: irrAnimColor };
        const realIrrItem = { 
            t: "بازدهی (واقعی)", v: m.realIrr!==null ? (m.realIrr*100).toFixed(1)+"%" : "N/A", s: realIrrTxt, c: realIrrC, i: "fa-gem", animColor: realIrrAnimColor,
            tooltip: "این کارت سودآوری واقعی پروژه را پس از کسر کامل اثرات تورم نمایش می‌دهد."
        };

        const otherR2 = [
            { t: "ارزش فعلی (NPV)", v: fmt.format(Math.round(m.npv)), s: npvTxt, c: npvC, i: "fa-sack-dollar" },
            { t: "بازگشت سرمایه (PP)", v: ppDisplay, s: "سال (از شروع)", c: "var(--warning)", i: "fa-hourglass-half" },
            { t: "بازگشت سود (PBP)", v: pbpDisplay, s: "سال (بهره‌برداری)", c: "var(--warning)", i: "fa-hourglass-end" },
            { t: "سربه‌سر (B.P)", v: m.bep.toFixed(1)+"%", s: "ریسک عملیاتی", c: "#0ea5e9", i: "fa-crosshairs" }
        ];

        const card = (d) => `
            <div class="kpi-card" style="--color:${d.c}">
                <div class="kpi-bg-icon-wrapper"><i class="fa-solid ${d.i} kpi-bg-icon"></i></div>
                <div class="kpi-top"><span class="kpi-title">${d.t}</span></div>
                <div class="kpi-val dir-ltr" style="color:${d.c}; text-shadow:0 0 10px ${d.c}20">${d.v}</div>
                <div class="kpi-sub">${d.s}</div>
            </div>`;

        const cardNominalIRR = (d) => `
            <div class="kpi-card irr-anim-card" style="--color:${d.c}; --anim-color:${d.animColor}">
                <div class="anim-glow"></div>
                <div class="kpi-bg-icon-wrapper"><i class="fa-solid ${d.i} kpi-bg-icon"></i></div>
                <div class="kpi-top"><span class="kpi-title">${d.t}</span></div>
                <div class="kpi-val dir-ltr" style="color:${d.c}; text-shadow:0 0 10px ${d.c}20">${d.v}</div>
                <div class="kpi-sub">${d.s}</div>
            </div>`;

        const cardRealIRR = (d) => `
            <div class="kpi-card real-irr-card" style="--color:${d.c}; --anim-color:${d.animColor}">
                <div class="radar-bg-container"><div class="radar-sweep"></div></div>
                <div class="kpi-bg-icon-wrapper"><i class="fa-solid ${d.i} kpi-bg-icon"></i></div>
                <div class="kpi-top">
                    <span class="kpi-title">
                        ${d.t} 
                        ${d.tooltip ? `<span class="info-tooltip" data-tooltip="${d.tooltip}"><i class="fa-solid fa-circle-info" style="color:var(--muted); font-size:0.95rem; margin-right:4px"></i></span>` : ''}
                    </span>
                </div>
                <div class="kpi-val dir-ltr" style="color:${d.c}; text-shadow:0 0 10px ${d.c}20">${d.v}</div>
                <div class="kpi-sub">${d.s}</div>
            </div>`;

        el('kpiContainer').innerHTML = r1.map(card).join('') + cardNominalIRR(irrItem) + cardRealIRR(realIrrItem) + otherR2.map(card).join('');
    }

    let cCash, cCost, cBe, cGrowth, cWeight, cRevenue;

    function initCharts() {
        Chart.defaults.font.family = "Vazirmatn";
        Chart.defaults.color = "#94a3b8";
        
        cCash = new Chart(el('cashChart').getContext('2d'), { type: 'bar', data: { labels: BASE.years, datasets: [] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true } } }, scales: { x: { grid: { display: false } }, y: { grid: { color: 'var(--border)' } } } } });
        cCost = new Chart(el('costChart').getContext('2d'), { type: 'doughnut', data: { labels: BASE.capexLabels, datasets: [{ data: BASE.capexParts, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, layout: { padding: 20 }, cutout: '55%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } }, datalabels: { color: '#fff', font: { weight: 'bold', family: 'Vazirmatn', size: 13 }, textShadowBlur: 4, textShadowColor: 'rgba(0,0,0,0.8)', display: (ctx) => { let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return (ctx.dataset.data[ctx.dataIndex] * 100 / sum) >= 4; }, formatter: (value, ctx) => { let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return (value*100 / sum).toFixed(1)+"%"; } } } }, plugins: [ChartDataLabels] });
        cBe = new Chart(el('beChart').getContext('2d'), { type: 'line', data: { labels: BASE.years, datasets: [] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true } } }, scales: { x: { grid: { display: false } }, y: { grid: { color: 'var(--border)' } } } } });
        cGrowth = new Chart(el('growthChart').getContext('2d'), { type: 'line', data: { labels: ['۱۴۰۱', '۱۴۰۲', '۱۴۰۳', '۱۴۰۴'], datasets: [{ label: 'تناژ ورودی', data: [171, 2144, 7482, 14450], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', borderWidth: 3, pointBackgroundColor: '#fff', pointBorderColor: '#f59e0b', pointRadius: 6, pointHoverRadius: 8, fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'تناژ (تن)' } } } } });
        
        const wLabels = ['سبک (<۱ تن)', 'نیمه سنگین (۱-۵ تن)', 'سنگین (۵-۲۰ تن)', 'فوق سنگین (>۲۰ تن)'];
        cWeight = new Chart(el('weightDonutChart').getContext('2d'), { type: 'doughnut', data: { labels: wLabels, datasets: [{ data: [1.5, 8.3, 40.1, 50.1], backgroundColor: ['#e2e8f0', '#94a3b8', '#0ea5e9', '#0f172a'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', layout: { padding: 15 }, plugins: { legend: { position: 'bottom' }, datalabels: { color: '#fff', font: { weight: 'bold' }, textShadowBlur: 4, textShadowColor: 'rgba(0,0,0,0.8)', display: (ctx) => ctx.dataset.data[ctx.dataIndex] > 4, formatter: (val) => val + "%" } } }, plugins: [ChartDataLabels] });
        cRevenue = new Chart(el('revenueBarChart').getContext('2d'), { type: 'bar', data: { labels: wLabels, datasets: [ { label: 'درصد وزنی', data: [1.5, 8.3, 40.1, 50.1], backgroundColor: '#0ea5e9', borderRadius: 4 }, { label: 'درصد درآمدی', data: [15.3, 21.8, 32.5, 30.4], backgroundColor: '#f59e0b', borderRadius: 4 } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, datalabels: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'درصد (%)' } } } } });
    }

    function updateChartsTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const colorText = isDark ? '#f1f5f9' : '#1e293b';
        const colorGrid = isDark ? '#334155' : '#e2e8f0'; 
        [cCash, cCost, cBe, cGrowth, cWeight, cRevenue].forEach(c => {
            if(c.options.scales?.y) c.options.scales.y.grid.color = colorGrid;
            if(c.options.plugins?.legend?.labels) c.options.plugins.legend.labels.color = colorText;
            c.update();
        });
    }

    function updateCharts(m, limit) {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        cCash.data.labels = BASE.years.slice(0, limit);
        cCash.data.datasets = [
            { type: 'line', label: 'جریان نقد خالص', data: m.annualNet, borderColor: isDark ? '#a78bfa' : '#4f46e5', borderWidth: 3, backgroundColor: isDark ? 'rgba(167, 139, 250, 0.2)' : 'rgba(79, 70, 229, 0.2)', fill: true, tension: 0.4, order: 0, pointBackgroundColor: isDark ? '#1e293b' : '#fff' },
            { type: 'bar', label: 'درآمدها', data: m.annualRev, backgroundColor: isDark ? '#34d399' : '#10b981', borderRadius: 4, order: 1, barPercentage: 0.6 },
            { type: 'bar', label: 'هزینه‌ها', data: m.annualExp, backgroundColor: isDark ? '#f87171' : '#ef4444', borderRadius: 4, order: 2, barPercentage: 0.6 }
        ];
        cCash.update();

        cCost.data.datasets[0].backgroundColor = isDark ? ['#6366f1', '#38bdf8', '#34d399', '#fbbf24', '#f87171', '#a855f7', '#ec4899'] : ['#4f46e5', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#9333ea', '#db2777'];
        cCost.update();

        cBe.data.labels = BASE.years.slice(0, limit);
        cBe.data.datasets = [
            { label: 'PP', data: m.cumCash, borderColor: isDark ? '#fbbf24' : '#f59e0b', borderWidth: 3, fill: false },
            { label: 'DPBP', data: m.cumDisc, borderColor: isDark ? '#38bdf8' : '#0ea5e9', borderDash: [5,5], borderWidth: 2, fill: false },
            { label: 'صفر', data: Array(limit).fill(0), borderColor: isDark ? '#f87171' : '#ef4444', borderWidth: 1 }
        ];
        cBe.update();
    }

    function renderMatrix(rVal, cVal, limit, infVal) {
        // --- 3-TIER MATRIX LOGIC ---
        let steps = [-0.20, -0.15, -0.10, -0.05, 0, 0.05, 0.10, 0.15, 0.20]; // Desktop
        if (window.innerWidth <= 768) {
            steps = [-0.20, -0.10, 0, 0.10, 0.20]; // Tablet & Mobile
        }

        const currentD = parseInt(el('discRange').value);
        
        let h = '<thead><tr><th>درآمد ↓ \\ هزینه →</th>';
        steps.forEach(s => h += `<th>${s>0?'+':''}${Math.round(s*100)}%</th>`);
        h += '</tr></thead><tbody>';
        
        steps.forEach(rs => {
            h += `<tr><th>${rs>0?'+':''}${Math.round(rs*100)}%</th>`;
            steps.forEach(cs => {
                const tr = rVal + (rs*100);
                const tc = cVal + (cs*100);
                const m = calcMetrics(tr, tc, currentD, limit, infVal);
                const val = m.irr ? Math.round(m.irr*100) : 0;
                
                let cls = 'matrix-cell ';
                if(val < currentD) cls += 'bg-red';
                else if(val <= currentD + 5) cls += 'bg-orange';
                else cls += 'bg-green';
                
                const border = (Math.abs(rs)<0.01 && Math.abs(cs)<0.01) ? '2px solid var(--primary)' : '1px solid transparent';
                
                h += `<td class="${cls}" data-val="${val}%" style="border:${border}">${val}%</td>`;
            }); 
            h += '</tr>';
        }); 
        el('matrixTable').innerHTML = h + '</tbody>';
    }

    function update() {
        const r = parseInt(el('revRange').value);
        const c = parseInt(el('costRange').value);
        const d = parseInt(el('discRange').value);
        const p = parseInt(el('periodRange').value);
        const inf = parseInt(el('infRange').value);

        const rvEl = el('revVal');
        rvEl.innerText = (r>0?'+':'')+r+'%';
        rvEl.className = 'val-tag ' + (r>0 ? 'val-pos' : r<0 ? 'val-neg' : 'val-neu');

        const cvEl = el('costVal');
        cvEl.innerText = (c>0?'+':'')+c+'%';
        cvEl.className = 'val-tag ' + (c>0 ? 'val-neg' : c<0 ? 'val-pos' : 'val-neu'); 

        el('discVal').innerText = d+'%';
        el('periodVal').innerText = p + ' سال';
        el('infVal').innerText = inf + '%';

        const m = calcMetrics(r, c, d, p, inf);
        renderKPIs(m, d, p);
        updateCharts(m, p);
        renderMatrix(r, c, p, inf);
    }

    function resetDefaults() {
        el('revRange').value = 0;
        el('costRange').value = 0;
        el('discRange').value = 35;
        el('periodRange').value = 10;
        el('infRange').value = 53;
        update();
    }

    ['revRange','costRange','discRange','periodRange', 'infRange'].forEach(id => el(id).addEventListener('input', update));
    initCharts();
    update();
    updateChartsTheme();
  </script>
</body>
</html>
